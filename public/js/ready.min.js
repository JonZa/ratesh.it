tinysort.defaults.order = 'desc';
var feed = new Instafeed({
	get: 'user',
	clientId: 'c87a6995dc164521bcc4172a6f51f052',
	accessToken: token,
	userId: userId,
	target: hashtag,
	filter: function(image) {
		return image.tags.indexOf(hashtag) >= 0;
	},
	after: function() {
		bindSorts();
		var total = 0;
		var score = 0;
		var scores = [];
		$.each(
			$('.score'),
			function() {
				total++;
				var $this = $(this);
				var text = $this.text();
				text = text.substring(text.lastIndexOf(' ')).split('/').join('</span> / ');
				$this.html('<span>' + text).show().find('span').show();
				var add = Number(text.split('</span> /')[0]);
				score += add;
				scores.push(add);
			}
		);
		score = score / total;
		scores.sort()
		var median = scores[Math.floor(scores.length / 2)];
		$('#complete strong').text(total + ' / 100');
		$('#median strong').text(median + ' / 10');
		$('#average strong').text(score.toString().substring(0, 3) + ' / 10').closest('div').show();
		$('.score').css('display','block');
		$('[data-sort=".score>span"]').click();
	},
	template: '<div class="pure-u-1-2 pure-u-sm-1-3"><div class="image">' +
		'<a target="_blank" href="{{link}}"><img src="{{image}}" class="pure-img"></a>' +
		'<a target="_blank" href="https://www.google.com/search?q={{location}}+sydney">{{location}}' +
		'<span class="score">{{caption}}</span></a>' +
		'<span class="date">{{model.created_time}}</span>' +
		'</div></div>'
	}
);
var bindSorts = function() {
	$('[data-sort]').on(
		'click',
		function(e) {
			e.preventDefault();
			var $this = $(this);
			if ($this.hasClass('active')) {
				return false;
			} else {
				$this.parent().find('a').toggleClass('active');
			}
			var criteria = $(this).attr('data-sort');
			tinysort('#' + hashtag + ' > div > .image', criteria);
			$('.image').matchHeight();
		}
	);
}
var runAgain = function() {
	feed.next();
}
feed.run();
$().ready(function() {
	$('.image').matchHeight();
});
